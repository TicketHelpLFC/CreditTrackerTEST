<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0b0b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <title>TicketHelpLFC ‚Äì Credit Tracker</title>
  <link rel="stylesheet" href="styles.css" />
<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --muted:#9aa0a6;
  --text:#f2f2f2;
  --border:#242424;
  --accent:#e31b23;
  --good:#2ecc71;
  --bad:#ff4d4d;
  --chip:#1b1b1b;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}

.topbar{
  position:sticky; top:0;
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid var(--border);
  background:rgba(11,11,11,.92);
  backdrop-filter: blur(10px);
  z-index:10;
}

.brand{display:flex; gap:10px; align-items:center}
.logo{font-size:22px}
.title{font-weight:800; letter-spacing:.2px}
.subtitle{color:var(--muted); font-size:12px; margin-top:2px}

.container{max-width:980px; margin:0 auto; padding:14px}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}

.row{display:flex; align-items:center}
.space-between{justify-content:space-between}
.gap{gap:10px}
.wrap{flex-wrap:wrap}
.grow{flex:1}

.label{font-weight:700; margin-bottom:6px}
.hint{color:var(--muted); font-size:12px; line-height:1.35}

.tabs{
  display:flex; gap:8px;
  margin:10px 0 14px;
}
.tab{
  flex:1;
  border-radius:12px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  padding:10px 10px;
  font-weight:700;
}
.tab.active{border-color:rgba(227,27,35,.6); background:rgba(227,27,35,.12)}

.grid3{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
.grid2{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px}

@media (max-width:720px){
  .grid3{grid-template-columns:1fr}
  .grid2{grid-template-columns:1fr}
}

.statTitle{color:var(--muted); font-size:12px; margin-bottom:6px}
.statValue{font-size:34px; font-weight:900}

.input,.select,.textarea{
  width:100%;
  padding:10px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#0f0f0f;
  color:var(--text);
}

.textarea{resize:vertical}

.fieldLabel{color:var(--muted); font-size:12px; margin:6px 0}

.btn{
  border:1px solid var(--border);
  background:#101010;
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
}
.btn.primary{
  border-color: rgba(46,204,113,.5);
  background: rgba(46,204,113,.12);
}
.btn.danger{
  border-color: rgba(255,77,77,.5);
  background: rgba(255,77,77,.12);
}
.btn.ghost{background:transparent}
.fileBtn{display:inline-flex; align-items:center; gap:6px}

.list{display:flex; flex-direction:column; gap:10px; margin-top:10px}
.item{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  background:#0f0f0f;
}
.itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
.itemTitle{font-weight:900}
.itemMeta{color:var(--muted); font-size:12px; margin-top:4px}
.itemBadges{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
.badge{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  border:1px solid var(--border);
  background: var(--chip);
}
.badge.good{border-color: rgba(46,204,113,.5)}
.badge.bad{border-color: rgba(255,77,77,.5)}
.badge.neutral{border-color: rgba(154,160,166,.45)}
.badge.red{border-color: rgba(227,27,35,.55)}

.chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
.chip{
  border:1px solid var(--border);
  background: var(--chip);
  color: var(--text);
  padding:8px 10px;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.chip.active{border-color: rgba(227,27,35,.55); background: rgba(227,27,35,.12)}

.hidden{display:none !important}
.empty{color:var(--muted); padding:10px 0}

.sep{border:0; height:1px; background:var(--border); margin:14px 0}

.modal{
  border:1px solid var(--border);
  border-radius:16px;
  padding:0;
  background:transparent;
  width:min(720px, calc(100vw - 20px));
}
.modal::backdrop{background:rgba(0,0,0,.55)}
.modalInner{
  background:var(--card);
  border-radius:16px;
  padding:14px;
}
.toggleRow{margin:10px 0}
.toggle span{margin-left:8px}


.breakdownTable{width:100%; border-collapse:separate; border-spacing:0 8px;}
.breakdownTable th{color:var(--muted); font-size:12px; text-align:left; font-weight:800; padding:0 8px 6px;}
.breakdownTable td{background:#0f0f0f; border:1px solid var(--border); padding:10px 8px;}
.breakdownTable td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px;}
.breakdownTable td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px; text-align:right; font-weight:900;}
.breakdownPill{display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--chip); font-size:12px; font-weight:800;}
.breakdownPill.good{border-color: rgba(46,204,113,.5);}
.breakdownPill.bad{border-color: rgba(255,77,77,.5);}



.grid5{display:grid; grid-template-columns:repeat(5, 1fr); gap:10px}
@media (max-width:980px){
  .grid5{grid-template-columns:repeat(2, 1fr)}
}
@media (max-width:720px){
  .grid5{grid-template-columns:1fr}
}

.stat.small{padding:12px}
.statValue.small{font-size:26px}


.breakdownTable{width:100%; border-collapse:collapse; margin-top:10px}
.breakdownTable th,.breakdownTable td{padding:10px; border-bottom:1px solid var(--border); text-align:left}
.breakdownPill{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--chip); font-weight:800; font-size:12px}
.breakdownPill.good{border-color: rgba(46,204,113,.5); background: rgba(46,204,113,.12)}
.breakdownPill.neutral{border-color: rgba(154,160,166,.45); background: rgba(154,160,166,.10)}


.modal.hidden{display:none !important}

.brandLogo{width:34px;height:34px;border-radius:10px;display:block}


.headerActions{ display:flex; gap:10px; align-items:center; }
@media (max-width: 520px){
  .headerActions{ gap:8px; }
  #btnSupport{ padding:8px 10px; font-size:13px; }
}

.modalHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
.modalTitle{ font-weight:800; font-size:18px; }
.hr{ height:1px; background: rgba(255,255,255,.08); margin:12px 0; border-radius:999px; }

.fieldLabel{ font-weight:700; margin-bottom:6px; }
.input, .textarea{
  width:100%;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:10px 12px;
  color: var(--text);
  outline:none;
}
.input:focus, .textarea:focus{ border-color: rgba(227,27,35,.55); }
.textarea{ resize: vertical; min-height: 110px; }
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img class="brandLogo" src="icons/icon-192.png" alt="TicketHelpLFC" />
      <div>
        <div class="title">TicketHelpLFC</div>
        <div class="subtitle">Credit Tracker</div>
      </div>
    </div>
    <div class="headerActions">
      <button id="btnSupport" class="btn ghost">üí¨ Support</button>
      <button id="btnInstall" class="btn ghost" hidden>‚¨áÔ∏è Install</button>
    </div>
  </header>

  <main class="container">
    <!-- Season bar -->
    <section class="card row space-between">
      <div class="row gap wrap">
        <div>
          <div class="label">üë§ Account</div>
          <select id="accountSelect" class="select"></select>
        </div>
        <div class="row gap" style="margin-top:8px;">
          <button type="button" id="btnEditAccount" class="btn">‚úèÔ∏è Edit</button>
          <button type="button" id="btnDeleteAccount" class="btn danger">üóëÔ∏è Delete</button>
        </div>
        <div>
          <div class="label">üìÖ Season</div>
          <select id="seasonSelect" class="select" data-role="season"></select>
        </div>
      </div>
      <div class="row gap">
        <button id="btnAddAccount" class="btn">‚ûï Add account to track</button>
        <button id="btnSettings" class="btn ghost">‚öôÔ∏è</button>
      </div>
    </section>

    <!-- Views -->
    <nav class="tabs">
      <button class="tab active" data-view="dash">üè† Dashboard</button>
      <button class="tab" data-view="matches">üìã Matches</button>
      <button class="tab" data-view="fixtures">üìÖ Fixtures</button>
      <button class="tab" data-view="add">‚ûï Add</button>
    </nav>


    <!-- Setup (no popup) -->
    <section id="viewSetup" class="view hidden">
      <section class="card">
        <div class="label">üî¥ TicketHelpLFC ‚Äì Setup</div>
        <div class="hint">Set up the accounts you want to track. No logins. Data stays on your device.</div>
      </section>

      <section class="card">
        <div class="label">üë• Accounts</div>
        <div class="grid2">
          <div>
            <div class="fieldLabel">How many accounts?</div>
            <input id="setupCount" class="input" type="number" min="1" max="10" value="1" />
          </div>
          <div>
            <div class="fieldLabel">Season</div>
            <select id="setupSeason" class="select" data-role="season"></select>
          </div>
        </div>

        <div class="fieldLabel" style="margin-top:10px;">AutoCup (HOME only ‚Äî Away credits still tracked)</div>
<div class="hint" style="margin-top:10px;">Enter names below. You can also set AutoCup per account (defaults pre-filled).</div>
        <div id="setupNames" class="list" style="margin-top:10px;"></div>

        <div class="row gap wrap" style="margin-top:14px;">
          <button id="btnSetupCreate" class="btn primary">üü¢ Save setup</button>
        </div>
      </section>
    </section>

    <!-- Dashboard -->
    <section id="viewDash" class="view">

      <!-- Per-competition credits first -->
      <section class="card">
        <div class="row space-between">
          <div>
            <div class="label">üèÜ Credits by Competition</div>
            <div class="hint">Home (H) + Away (A) tracked separately. Cup comps show ‚ÄúAutoCup‚Äù if enabled for this account.</div>
          </div>
        </div>
        <div id="compBreakdown" class="breakdown"></div>
      </section>
</section>

    <!-- Matches -->
    <section id="viewMatches" class="view hidden">
      <section class="card">
        <div class="row wrap gap">
          <input id="searchInput" class="input grow" placeholder="Search opponent / notes‚Ä¶" />
          <select id="matchSort" class="select">
            <option value="matchDate" selected>Sort: Match date</option>
            <option value="dateAdded">Sort: Date added</option>
          </select>
          <select id="filterVenue" class="select">
            <option value="">Venue: All</option>
            <option value="H">Home (H)</option>
            <option value="A">Away (A)</option>
          </select>
          <select id="filterComp" class="select">
            <option value="">Comp: All</option>
            <option value="PL">PL</option>
            <option value="UCL">UCL</option>
            <option value="FAC">FA Cup</option>
            <option value="LC">League Cup</option>
            <option value="OTHER">Other</option>
          </select>
          <select id="filterCredit" class="select">
            <option value="">Credit: All</option>
            <option value="yes">üü¢ Yes</option>
            <option value="no">üî¥ No</option>
            <option value="unsure">‚ÑπÔ∏è Unsure</option>
          </select>
        </div>
      </section>
      <section class="card">
        <div id="matchesList" class="list"></div>
        <div id="matchesEmpty" class="empty hidden">
          üéüÔ∏è No matches yet ‚Äî tap <strong>‚ûï Add</strong> to start tracking.
        </div>
      </section>
    </section>

    <!-- Add/Edit -->
    <section id="viewAdd" class="view hidden">
      <section class="card">
        <div class="row space-between">
          <div class="label">‚ûï Add / Edit match</div>
          <button id="btnClearForm" class="btn ghost">üßπ Clear</button>
        </div>

        <form id="matchForm" class="form">
          <input type="hidden" id="matchId" />

          <div class="grid2">
            <div>
              <div class="fieldLabel">Opponent</div>
              <input id="opponent" class="input" placeholder="e.g. Arsenal" required />
            </div>
            <div>
              <div class="fieldLabel">Date</div>
              <input id="matchDate" class="input" type="date" required />
            </div>

            <div>
              <div class="fieldLabel">Home/Away</div>
              <select id="venue" class="select" required>
                <option value="H">Home (H)</option>
                <option value="A">Away (A)</option>
              </select>
            </div>

            <div>
              <div class="fieldLabel">Competition</div>
              <select id="competition" class="select" required>
                <option value="PL">PL</option>
                <option value="UCL">UCL</option>
                <option value="FAC">FA Cup</option>
                <option value="LC">League Cup</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            
            <div>
              <div class="fieldLabel">Ticket</div>
              <select id="ticketAction" class="select">
                <option value="credit">Credit</option>
                <option value="season_return">Season Ticket Return</option>
                <option value="fwd_me_credit">Forwarded to me (with credit)</option>
                <option value="fwd_me_nocredit">Forwarded to me (no credit)</option>
                <option value="hosp_credit">Hospitality (credit)</option>
                <option value="hosp_nocredit">Hospitality (no credit)</option>
                <option value="scan_nocredit">Scan in (no credit)</option>
              </select>
            </div>

          </div>

          <div>
            <div class="fieldLabel">Credit outcome</div>
            <div class="chips" role="group" aria-label="Credit outcome">
<input type="hidden" id="creditCounts" value="unsure">

              <button type="button" class="chip" data-credit="yes">üü¢ Credit</button>
              <button type="button" class="chip" data-credit="no">üî¥ No credit</button>
              <button type="button" class="chip active" data-credit="unsure">‚ÑπÔ∏è Unsure</button>
            </div>
            <input type="hidden" id="creditCredit" value="unsure" />
          </div>

          <div>
            <div class="fieldLabel">Ticket cost (optional)</div>
            <input id="amountPaid" class="input" type="number" min="0" step="0.01" placeholder="e.g. 43.85" />
            <div class="hint">Leave blank if unknown. Stored locally.</div>
          </div>

          <div>
            <div class="fieldLabel">Notes (optional)</div>
            <textarea id="notes" class="textarea" rows="3" placeholder="Anything worth remembering‚Ä¶"></textarea>
          </div>

          <div class="row space-between">
            <button type="submit" class="btn primary">üü¢ Save match</button>
            <button type="button" id="btnDelete" class="btn danger" hidden>‚ùå Delete</button>
          </div>

          <div class="hint">
            üîí Stored on your device. Not affiliated with Liverpool FC.
          </div>
        </form>
      </section>
    </section>

    <!-- Settings modal -->
    <dialog id="settingsModal" class="modal hidden">
      <div class="modalInner">
        <div class="row space-between">
          <div class="label">‚öôÔ∏è Rules & Settings</div>
          <button id="btnCloseSettings" class="btn ghost">‚úñÔ∏è</button>
        </div>

        <div class="hint">These toggles only affect defaults & hints (your data is still editable).</div>

        <div class="toggleRow">
          <label class="toggle">
            <input type="checkbox" id="ruleForwardedNoCredit" checked />
            <span>Forwarded = No credit (default)</span>
          </label>
        </div>
        <div class="toggleRow">
          <label class="toggle">
            <input type="checkbox" id="ruleReturnedNoCredit" checked />
            <span>Returned = No credit (default)</span>
          </label>
        </div>
        <div class="toggleRow">
          <label class="toggle">
            <input type="checkbox" id="ruleHospitalityNoCredit" checked />
            <span>Hospitality = No credit (default)</span>
          </label>
        </div>

        <hr class="sep"/>

        <div class="label">üì¶ Backups</div>
        <div class="row gap wrap">
          <button id="btnExportJSON2" class="btn">üì§ Export JSON</button>
          <button id="btnExportCSV2" class="btn">üì§ Export CSV</button>
          <label class="btn fileBtn">
            üì• Import JSON
            <input id="importFile2" type="file" accept="application/json" hidden />
          </label>
        </div>

        <div class="hint">
          ‚ÄúJSON‚Äù is best for restoring exactly. ‚ÄúCSV‚Äù is for spreadsheets.
        </div>
      </div>
    
      <hr class="sep" />
      <div id="settingsData">
        <div class="label">üì¶ Data</div>
        <div class="row gap wrap" style="margin-top:8px;">
          <button id="btnExportJSON" class="btn ghost">üì§ Export JSON</button>
          <button id="btnExportCSV" class="btn ghost">üì§ Export CSV</button>
          <label class="btn ghost fileBtn">
            üì• Import JSON
            <input id="importFile" type="file" accept="application/json" hidden />
          </label>
        </div>
        <div class="hint" style="margin-top:6px;">Export/Import is stored locally on this device.</div>
      </div>
</dialog>
  <!-- Support & Feedback -->
<dialog id="supportModal" class="modal hidden">
  <div class="modalInner">
    <div class="modalHeader">
      <div class="modalTitle">üí¨ Support & Feedback</div>
      <button type="button" class="btn ghost sm" id="btnCloseSupport" aria-label="Close">‚úñ</button>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 6px;">‚òï Support the tools</h3>
    <div class="hint" style="margin-bottom:10px;">
      If these tools help you get to games, you can chip in to support hosting + ongoing updates.
    </div>
    <button type="button" id="btnBmac" class="btn full">Open Buy Me a Coffee</button>

    <div class="hr" style="margin-top:16px;"></div>

    <h3 style="margin:0 0 6px;">üìù Send feedback</h3>
    <div class="hint" style="margin-bottom:10px;">
      Found a bug or have an idea? Drop it below and hit send.
    </div>

    <div class="field">
      <div class="fieldLabel">Your email (optional)</div>
      <input id="feedbackEmail" class="input" type="email" placeholder="you@example.com" />
    </div>

    <div class="field" style="margin-top:10px;">
      <div class="fieldLabel">Message</div>
      <textarea id="feedbackMsg" class="textarea" rows="5" placeholder="Tell me what happened / what you'd like added..."></textarea>
    </div>

    <div class="row" style="margin-top:12px; gap:10px;">
      <button type="button" id="btnSendFeedback" class="btn full">Send feedback</button>
    </div>

    <div id="feedbackStatus" class="hint" style="margin-top:10px;"></div>

    <div class="hr" style="margin-top:14px;"></div>
    <div class="hint" style="opacity:.85;">
      Note: feedback uses your device email app by default. If you want it to send silently, we can wire this to a form endpoint (Formspree/Netlify/Google Form).
    </div>
  </div>
</dialog>
</main>

  <div class="hint" style="text-align:center;margin:20px 0;">Build: 3.6.24 (Single-file + PWA)</div>

<script type="application/json" id="fixturesData">[{"id": "2025-08-15-pl-bournemouth-h-2000", "season": "25/26", "date": "2025-08-15", "time": "20:00", "datetime_utc": "2025-08-15T20:00:00Z", "competition": "PL", "opponent": "Bournemouth", "venue": "H", "location": ""}, {"id": "2025-08-23-pl-newcastleunited-a-1500", "season": "25/26", "date": "2025-08-23", "time": "15:00", "datetime_utc": "2025-08-23T15:00:00Z", "competition": "PL", "opponent": "Newcastle United", "venue": "A", "location": ""}, {"id": "2025-08-30-pl-arsenal-h-1500", "season": "25/26", "date": "2025-08-30", "time": "15:00", "datetime_utc": "2025-08-30T15:00:00Z", "competition": "PL", "opponent": "Arsenal", "venue": "H", "location": ""}, {"id": "2025-09-13-pl-burnley-a-1500", "season": "25/26", "date": "2025-09-13", "time": "15:00", "datetime_utc": "2025-09-13T15:00:00Z", "competition": "PL", "opponent": "Burnley", "venue": "A", "location": ""}, {"id": "2025-09-20-pl-everton-h-1500", "season": "25/26", "date": "2025-09-20", "time": "15:00", "datetime_utc": "2025-09-20T15:00:00Z", "competition": "PL", "opponent": "Everton", "venue": "H", "location": ""}, {"id": "2025-09-27-pl-crystalpalace-a-1500", "season": "25/26", "date": "2025-09-27", "time": "15:00", "datetime_utc": "2025-09-27T15:00:00Z", "competition": "PL", "opponent": "Crystal Palace", "venue": "A", "location": ""}, {"id": "2025-10-04-pl-chelsea-a-1500", "season": "25/26", "date": "2025-10-04", "time": "15:00", "datetime_utc": "2025-10-04T15:00:00Z", "competition": "PL", "opponent": "Chelsea", "venue": "A", "location": ""}, {"id": "2025-10-18-pl-manchesterunited-h-1500", "season": "25/26", "date": "2025-10-18", "time": "15:00", "datetime_utc": "2025-10-18T15:00:00Z", "competition": "PL", "opponent": "Manchester United", "venue": "H", "location": ""}, {"id": "2025-10-25-pl-brentford-a-1500", "season": "25/26", "date": "2025-10-25", "time": "15:00", "datetime_utc": "2025-10-25T15:00:00Z", "competition": "PL", "opponent": "Brentford", "venue": "A", "location": ""}, {"id": "2025-11-01-pl-astonvilla-h-1500", "season": "25/26", "date": "2025-11-01", "time": "15:00", "datetime_utc": "2025-11-01T15:00:00Z", "competition": "PL", "opponent": "Aston Villa", "venue": "H", "location": ""}, {"id": "2025-11-08-pl-manchestercity-a-1500", "season": "25/26", "date": "2025-11-08", "time": "15:00", "datetime_utc": "2025-11-08T15:00:00Z", "competition": "PL", "opponent": "Manchester City", "venue": "A", "location": ""}, {"id": "2025-11-22-pl-nottinghamforest-h-1500", "season": "25/26", "date": "2025-11-22", "time": "15:00", "datetime_utc": "2025-11-22T15:00:00Z", "competition": "PL", "opponent": "Nottingham Forest", "venue": "H", "location": ""}, {"id": "2025-11-29-pl-westhamunited-a-1500", "season": "25/26", "date": "2025-11-29", "time": "15:00", "datetime_utc": "2025-11-29T15:00:00Z", "competition": "PL", "opponent": "West Ham United", "venue": "A", "location": ""}, {"id": "2025-12-03-pl-sunderland-h-2000", "season": "25/26", "date": "2025-12-03", "time": "20:00", "datetime_utc": "2025-12-03T20:00:00Z", "competition": "PL", "opponent": "Sunderland", "venue": "H", "location": ""}, {"id": "2025-12-06-pl-leedsunited-a-1500", "season": "25/26", "date": "2025-12-06", "time": "15:00", "datetime_utc": "2025-12-06T15:00:00Z", "competition": "PL", "opponent": "Leeds United", "venue": "A", "location": ""}, {"id": "2025-12-13-pl-brightonhovealbion-h-1500", "season": "25/26", "date": "2025-12-13", "time": "15:00", "datetime_utc": "2025-12-13T15:00:00Z", "competition": "PL", "opponent": "Brighton & Hove Albion", "venue": "H", "location": ""}, {"id": "2025-12-20-pl-tottenhamhotspur-a-1500", "season": "25/26", "date": "2025-12-20", "time": "15:00", "datetime_utc": "2025-12-20T15:00:00Z", "competition": "PL", "opponent": "Tottenham Hotspur", "venue": "A", "location": ""}, {"id": "2025-12-27-pl-wolverhamptonwanderers-h-1500", "season": "25/26", "date": "2025-12-27", "time": "15:00", "datetime_utc": "2025-12-27T15:00:00Z", "competition": "PL", "opponent": "Wolverhampton Wanderers", "venue": "H", "location": ""}, {"id": "2025-12-30-pl-leedsunited-h-2000", "season": "25/26", "date": "2025-12-30", "time": "20:00", "datetime_utc": "2025-12-30T20:00:00Z", "competition": "PL", "opponent": "Leeds United", "venue": "H", "location": ""}, {"id": "2026-01-08-pl-arsenal-a", "season": "25/26", "datetime_utc": "2026-01-08T00:00:00+00:00", "date": "2026-01-08", "time": "00:00", "competition": "PL", "opponent": "Arsenal", "venue": "A", "location": "Emirates Stadium\\, London"}, {"id": "2026-01-12-fa-barnsley-h", "season": "25/26", "datetime_utc": "2026-01-12T00:00:00+00:00", "date": "2026-01-12", "time": "00:00", "competition": "FA", "opponent": "Barnsley", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-01-17-pl-burnley-h", "season": "25/26", "datetime_utc": "2026-01-17T00:00:00+00:00", "date": "2026-01-17", "time": "00:00", "competition": "PL", "opponent": "Burnley", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-01-18-other-welcometoliverpoolfc!-h", "season": "25/26", "datetime_utc": "2026-01-18T00:00:00+00:00", "date": "2026-01-18", "time": "00:00", "competition": "OTHER", "opponent": "Welcome to Liverpool FC!", "venue": "H", "location": "Proudly powered by ECAL"}, {"id": "2026-01-21-ucl-marseille-a", "season": "25/26", "datetime_utc": "2026-01-21T00:00:00+00:00", "date": "2026-01-21", "time": "00:00", "competition": "UCL", "opponent": "Marseille", "venue": "A", "location": "Orange V√©lodrome\\, Marseille"}, {"id": "2026-01-24-pl-bournemouth-a", "season": "25/26", "datetime_utc": "2026-01-24T00:00:00+00:00", "date": "2026-01-24", "time": "00:00", "competition": "PL", "opponent": "Bournemouth", "venue": "A", "location": "Vitality Stadium\\, Bournemouth"}, {"id": "2026-01-28-ucl-qarabag-h", "season": "25/26", "datetime_utc": "2026-01-28T00:00:00+00:00", "date": "2026-01-28", "time": "00:00", "competition": "UCL", "opponent": "Qarabag", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-01-31-pl-newcastleunited-h", "season": "25/26", "datetime_utc": "2026-01-31T00:00:00+00:00", "date": "2026-01-31", "time": "00:00", "competition": "PL", "opponent": "Newcastle United", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-02-08-pl-manchestercity-h", "season": "25/26", "datetime_utc": "2026-02-08T00:00:00+00:00", "date": "2026-02-08", "time": "00:00", "competition": "PL", "opponent": "Manchester City", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-02-11-pl-sunderland-a", "season": "25/26", "datetime_utc": "2026-02-11T00:00:00+00:00", "date": "2026-02-11", "time": "00:00", "competition": "PL", "opponent": "Sunderland", "venue": "A", "location": "Stadium of Light\\, Sunderland"}, {"id": "2026-02-14-fa-brightonandhovealbion-h", "season": "25/26", "datetime_utc": "2026-02-14T00:00:00+00:00", "date": "2026-02-14", "time": "00:00", "competition": "FA", "opponent": "Brighton and Hove Albion", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-02-21-pl-nottinghamforest-a", "season": "25/26", "datetime_utc": "2026-02-21T00:00:00+00:00", "date": "2026-02-21", "time": "00:00", "competition": "PL", "opponent": "Nottingham Forest", "venue": "A", "location": "The City Ground\\, Nottingham"}, {"id": "2026-02-28-pl-westhamunited-h", "season": "25/26", "datetime_utc": "2026-02-28T00:00:00+00:00", "date": "2026-02-28", "time": "00:00", "competition": "PL", "opponent": "West Ham United", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-03-04-pl-wolverhamptonwanderers-a", "season": "25/26", "datetime_utc": "2026-03-04T00:00:00+00:00", "date": "2026-03-04", "time": "00:00", "competition": "PL", "opponent": "Wolverhampton Wanderers", "venue": "A", "location": "Molineux Stadium\\, Wolverhampton"}, {"id": "2026-03-14-pl-tottenhamhotspur-h", "season": "25/26", "datetime_utc": "2026-03-14T00:00:00+00:00", "date": "2026-03-14", "time": "00:00", "competition": "PL", "opponent": "Tottenham Hotspur", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-03-21-pl-brightonandhovealbion-a", "season": "25/26", "datetime_utc": "2026-03-21T00:00:00+00:00", "date": "2026-03-21", "time": "00:00", "competition": "PL", "opponent": "Brighton and Hove Albion", "venue": "A", "location": "American Express Stadium\\, Falmer"}, {"id": "2026-04-11-pl-fulham-h", "season": "25/26", "datetime_utc": "2026-04-11T00:00:00+00:00", "date": "2026-04-11", "time": "00:00", "competition": "PL", "opponent": "Fulham", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-04-18-pl-everton-a", "season": "25/26", "datetime_utc": "2026-04-18T00:00:00+00:00", "date": "2026-04-18", "time": "00:00", "competition": "PL", "opponent": "Everton", "venue": "A", "location": "Hill Dickinson Stadium\\, Liverpool"}, {"id": "2026-04-25-pl-crystalpalace-h", "season": "25/26", "datetime_utc": "2026-04-25T00:00:00+00:00", "date": "2026-04-25", "time": "00:00", "competition": "PL", "opponent": "Crystal Palace", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-05-02-pl-manchesterunited-a", "season": "25/26", "datetime_utc": "2026-05-02T00:00:00+00:00", "date": "2026-05-02", "time": "00:00", "competition": "PL", "opponent": "Manchester United", "venue": "A", "location": "Old Trafford\\, Manchester"}, {"id": "2026-05-09-pl-chelsea-h", "season": "25/26", "datetime_utc": "2026-05-09T00:00:00+00:00", "date": "2026-05-09", "time": "00:00", "competition": "PL", "opponent": "Chelsea", "venue": "H", "location": "Anfield\\, Liverpool"}, {"id": "2026-05-17-pl-astonvilla-a", "season": "25/26", "datetime_utc": "2026-05-17T00:00:00+00:00", "date": "2026-05-17", "time": "00:00", "competition": "PL", "opponent": "Aston Villa", "venue": "A", "location": "Villa Park\\, Birmingham"}, {"id": "2026-05-24-pl-brentford-h", "season": "25/26", "datetime_utc": "2026-05-24T00:00:00+00:00", "date": "2026-05-24", "time": "00:00", "competition": "PL", "opponent": "Brentford", "venue": "H", "location": "Anfield\\, Liverpool"}]</sc<script>

/* Inlined app script (single-file build) */

/* Inlined app script (single-file build) */
const BUILD_VERSION = "3.6.16-gh";

function safeSetValue(id, val){
  const el = document.getElementById(id);
  if (!el) return false;
  el.value = val;
  return true;
}
/* TicketHelpLFC Credit Tracker ‚Äì PWA Starter (Local-only) */

const SUPPORT_BMAC_URL = "https://buymeacoffee.com/YOUR_PAGE"; // <-- replace with your real BuyMeACoffee link
const FEEDBACK_TO_EMAIL = "YOUR_EMAIL@example.com"; // <-- replace with your email address

const STORAGE_KEY = "thlfc_credit_tracker_v1";

const $ = (id) => document.getElementById(id);

function setText(id, value){ const el = $(id); if(el) el.textContent = value; }

const state = {
  data: null,
  deferredPrompt: null
};

function uid() {
  return crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);
}

function parseAmount(raw) {
  const s = String(raw ?? "").trim();
  if (!s) return null;
  // accept "¬£43.85", "43.85", "43,85"
  const cleaned = s.replace(/[^0-9.,-]/g, "").replace(/,/g, ".");
  const n = Number(cleaned);
  return Number.isFinite(n) ? Math.round(n * 100) / 100 : null;
}

function formatGBP(n) {
  if (n == null) return "¬£0";
  try {
    return new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP" }).format(n);
  } catch {
    return "¬£" + String(n);
  }
}

function todayISODate() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}


function currentSeasonIdFromDate() {
  // UK football season: Aug->May. In Jan 2026, that is 2025/26.
  const d = new Date();
  const y = d.getFullYear();
  const mth = d.getMonth() + 1; // 1-12
  const startYear = (mth >= 7) ? y : (y - 1); // July+ treat as new season start
  const endYear = startYear + 1;
  return `${startYear}-${String(endYear).slice(-2)}`;
}

function seasonLabelFromId(id) {
  // "2025-26" -> "25/26"
  const parts = String(id).split("-");
  if (parts.length !== 2) return id;
  const a = parts[0].slice(-2);
  const b = parts[1].slice(-2);
  return `${a}/${b}`;
}

function generateSeasons(rangeBack = 3, rangeForward = 6) {
  const cur = currentSeasonIdFromDate(); // e.g. "2025-26"
  const startYear = parseInt(cur.split("-")[0], 10);
  const seasons = [];
  for (let y = startYear - rangeBack; y <= startYear + rangeForward; y++) {
    const id = `${y}-${String(y + 1).slice(-2)}`;
    seasons.push({ id, label: seasonLabelFromId(id), createdAt: new Date().toISOString() });
  }
  return { seasons, activeSeasonId: cur };
}

function defaultData() {
  const gen = generateSeasons();
  return {
    version: 2,
    createdAt: new Date().toISOString(),
    settings: {
      ruleForwardedNoCredit: true,
      ruleReturnedNoCredit: true,
      ruleHospitalityNoCredit: true
    },
    seasons: gen.seasons,
    activeSeasonId: gen.activeSeasonId,

    // Multi-account support
    accounts: [], // {id, name, autoCup, createdAt}
    activeAccountId: null,

    matches: [] // MatchEntry[] {accountId, seasonId, ...}
  };
}

function load() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    state.data = defaultData();
    save();
    return;
  }
  try {
    state.data = JSON.parse(raw);
    if (!state.data || !state.data.seasons) throw new Error("Bad data");
  } catch {
    state.data = defaultData();
    save();
  }
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
}

function activeSeasonId() {
  return state.data.activeSeasonId;
}

function activeAccountId() {
  return state.data.activeAccountId;
}

function setActiveSeason(id) {
  state.data.activeSeasonId = id;
  save();
  renderAll();
}

function setActiveAccount(id) {
  state.data.activeAccountId = id;
  save();
  renderAll();
}

function seasonLabel(id) {
  const s = state.data.seasons.find(x => x.id === id);
  return s ? s.label : id;
}

function getSeasonMatches(seasonId) {
  const accId = activeAccountId();
  return state.data.matches.filter(m => m.seasonId === seasonId && (!accId || m.accountId === accId));
}

function creditIsCounted(match) {
  return match.creditCounts === "yes";
}

function computeSpend(seasonId) {
  const matches = getSeasonMatches(seasonId);
  const paid = matches.map(m => m.amountPaid).filter(v => typeof v === "number" && Number.isFinite(v));
  const total = paid.reduce((a,b) => a + b, 0);
  const avg = paid.length ? total / paid.length : 0;
  return { total, avg, count: paid.length };
}

function computeBreakdownByCompetition(seasonId) {
  const matches = getSeasonMatches(seasonId);
  const comps = ["PL","UCL","FAC","LC","OTHER"];
  const out = {};
  for (const c of comps) out[c] = { H: 0, A: 0 };
  for (const m of matches) {
    const c = out[m.competition] ? m.competition : "OTHER";
    if (m.creditCounts === "yes") {
      if (m.venue === "H") out[c].H += 1;
      if (m.venue === "A") out[c].A += 1;
    }
  }
  return out;
}

function computeTotals(seasonId) {
  const matches = getSeasonMatches(seasonId);
  let home = 0, away = 0;
  for (const m of matches) {
    if (creditIsCounted(m)) {
      if (m.venue === "H") home += 1;
      if (m.venue === "A") away += 1;
    }
  }
  return { home, away, total: home + away };
}

function eligibilityText(totals) {
  const max = Math.max(totals.home, totals.away, totals.total);
  if (max >= 13) return "Likely in a high-credit bracket (tracked).";
  if (max >= 4) return "You‚Äôre at 4+ in at least one category (tracked).";
  if (max >= 3) return "You‚Äôre at 3+ in at least one category (tracked).";
  if (max >= 2) return "You‚Äôre building credits (2+ tracked in a category).";
  if (max >= 1) return "You‚Äôve got 1+ tracked ‚Äî keep going.";
  return "Start logging matches to see your progress.";
}

function formatMatchTitle(m) {
  return `Liverpool vs ${m.opponent} (${m.venue})`;
}

function formatMeta(m) {
  const compMap = { PL: "PL", UCL: "UCL", FAC: "FA Cup", LC: "League Cup", OTHER: "Other" };
  const comp = compMap[m.competition] || m.competition;
  const date = m.matchDate || "‚Äî";
  return `${date} ‚Ä¢ ${comp}`;
}

function badgeForCredit(m) {
  if (m.creditCounts === "yes") return { text: "üü¢ Counts", cls: "good" };
  if (m.creditCounts === "no") return { text: "üî¥ No credit", cls: "bad" };
  return { text: "‚ÑπÔ∏è Unsure", cls: "neutral" };
}

function badgeForOutcome(m) {
  const map = { applied: "Applied", successful: "Successful", unsuccessful: "Unsuccessful", na: "Didn‚Äôt apply" };
  return { text: `üìÑ ${map[m.appliedStatus] || "‚Äî"}`, cls: "neutral" };
}

function badgeForAction(m) {
  const map = {
    credit: "Credit",
    season_return: "Season Ticket Return",
    fwd_me_credit: "Forwarded (credit)",
    fwd_me_nocredit: "Forwarded (no credit)",
    hosp_credit: "Hospitality (credit)",
    hosp_nocredit: "Hospitality (no credit)",
    scan_nocredit: "Scan in (no credit)"
  };
  return { text: `üéüÔ∏è ${map[m.ticketAction] || "‚Äî"}`, cls: "neutral" };
}

function setView(viewName) {
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(t => t.classList.toggle("active", t.dataset.view === viewName));

  $("viewSetup").classList.toggle("hidden", viewName !== "setup");
  $("viewDash").classList.toggle("hidden", viewName !== "dash");
  $("viewMatches").classList.toggle("hidden", viewName !== "matches");
  $("viewAdd").classList.toggle("hidden", viewName !== "add");
  if (viewName === "fixtures") { setTimeout(() => { bindFixturesControls(); renderFixtures(); }, 0); }
  if (viewName === "setup") { setTimeout(() => { try{ populateAllSeasonSelects(); }catch(e){} }, 0); }
  $("viewFixtures").classList.toggle("hidden", viewName !== "fixtures");
  if (viewName === "fixtures") { setTimeout(() => { bindFixturesControls(); renderFixtures(); }, 0); }
}


function renderSeasonSelect() {
  const sel = $("seasonSelect");
  sel.innerHTML = "";
  for (const s of state.data.seasons) {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.label;
    sel.appendChild(opt);
  }
  sel.value = activeSeasonId();

  // mirror into modals if present
  const onboardSeason = $("onboardSeason");
  if (onboardSeason) {
    onboardSeason.innerHTML = sel.innerHTML;
    onboardSeason.value = sel.value;
  }
  const setupSeason = $("setupSeason");
  if (setupSeason) {
    setupSeason.innerHTML = sel.innerHTML;
    setupSeason.value = sel.value;
  }
}

function renderAccountSelect() {
  const sel = $("accountSelect");
  if (!sel) return;
  sel.innerHTML = "";
  for (const a of state.data.accounts) {
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.name;
    sel.appendChild(opt);
  }
  sel.value = state.data.activeAccountId || (state.data.accounts[0] ? state.data.accounts[0].id : "");
  if (!state.data.activeAccountId && sel.value) {
    state.data.activeAccountId = sel.value;
    save();
  }
}

function renderDashboard() {
  if (!activeAccountId()) {
    if ($("statHome")) setText("statHome", "0");
    if ($("statAway")) setText("statAway", "0");
    if ($("statTotal")) setText("statTotal", "0");
    setText("statSpend", formatGBP(0));
    setText("statAvgSpend", formatGBP(0));
    const mount = $("compBreakdown");
    if (mount) mount.innerHTML = '<div class="empty">üë§ Add an account to start tracking.</div>';
    const root = $("recentList");
    if (root) root.innerHTML = '<div class="empty">No activity yet.</div>';
    return;
  }

  const totals = computeTotals(activeSeasonId());
  const spend = computeSpend(activeSeasonId());
  if ($("statHome")) setText("statHome", String(totals.home));
  if ($("statAway")) setText("statAway", String(totals.away));
  if ($("statTotal")) setText("statTotal", String(totals.total));
  setText("statSpend", formatGBP(spend.total));
  setText("statAvgSpend", formatGBP(spend.avg));

  // Competition breakdown table
  const acc = state.data.accounts.find(a => a.id === activeAccountId());
  const autoCup = (acc && acc.autoCup) ? acc.autoCup : {LC:false,FAC:false,UCL:false};
  const breakdown = computeBreakdownByCompetition(activeSeasonId());
  const labels = { PL: "Premier League", UCL: "UCL", FAC: "FA Cup", LC: "League Cup", OTHER: "Other" };
  const table = document.createElement("table");
  table.className = "breakdownTable";
  table.innerHTML = `
    <thead>
      <tr>
        <th>Competition</th>
        <th>Home</th>
        <th>Away</th>
      </tr>
    </thead>`;
  const tbody = document.createElement("tbody");
  for (const key of Object.keys(breakdown)) {
    const row = document.createElement("tr");
    const comp = document.createElement("td");
    comp.textContent = labels[key] || key;
    const h = document.createElement("td");
    const homeAuto = (key === "LC" && autoCup.LC) || (key === "FAC" && autoCup.FAC) || (key === "UCL" && autoCup.UCL);
    if (homeAuto) {
      h.innerHTML = `<span class="breakdownPill neutral">AutoCup</span>`;
    } else {
      h.innerHTML = `<span class="breakdownPill good">H: ${breakdown[key].H}</span>`;
    }
    const a = document.createElement("td");
    a.innerHTML = `<span class="breakdownPill good">A: ${breakdown[key].A}</span>`;
    row.appendChild(comp);
    row.appendChild(h);
    row.appendChild(a);
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  const mount = $("compBreakdown");
  mount.innerHTML = "";
  mount.appendChild(table);

  // Recent list: last 6 updated
  const matches = getSeasonMatches(activeSeasonId())
    .slice()
    .sort((a,b) => (b.updatedAt || b.createdAt).localeCompare(a.updatedAt || a.createdAt))
    .slice(0, 6);

  const root = $("recentList");
  root.innerHTML = "";

  if (matches.length === 0) {
    const div = document.createElement("div");
    div.className = "empty";
    div.textContent = "üéüÔ∏è No matches yet ‚Äî tap ‚ûï Add match to start tracking.";
    root.appendChild(div);
    return;
  }

  for (const m of matches) {
    root.appendChild(matchCard(m));
  }

}

function matchCard(m) {
  const div = document.createElement("div");
  div.className = "item";
  div.tabIndex = 0;
  div.role = "button";

  const top = document.createElement("div");
  top.className = "itemTop";

  const left = document.createElement("div");
  const title = document.createElement("div");
  title.className = "itemTitle";
  title.textContent = formatMatchTitle(m);
  const meta = document.createElement("div");
  meta.className = "itemMeta";
  meta.textContent = formatMeta(m);
  left.appendChild(title);
  left.appendChild(meta);

  const right = document.createElement("div");
  const credit = badgeForCredit(m);
  const creditBadge = document.createElement("div");
  creditBadge.className = `badge ${credit.cls}`;
  creditBadge.textContent = credit.text;
  right.appendChild(creditBadge);

  top.appendChild(left);
  top.appendChild(right);

  const badges = document.createElement("div");
  badges.className = "itemBadges";

  if (typeof m.amountPaid === "number" && Number.isFinite(m.amountPaid)) {
    const cost = document.createElement("div");
    cost.className = "badge neutral";
    cost.textContent = `üí∑ ${formatGBP(m.amountPaid)}`;
    badges.appendChild(cost);
  }
  const b2 = badgeForAction(m);

  const action = document.createElement("div");
  action.className = `badge ${b2.cls}`;
  action.textContent = b2.text;

  const comp = document.createElement("div");
  comp.className = "badge red";
  comp.textContent = `üè∑Ô∏è ${m.competition}`;
  badges.appendChild(action);
  badges.appendChild(comp);

  div.appendChild(top);
  div.appendChild(badges);

  if (m.notes && m.notes.trim()) {
    const notes = document.createElement("div");
    notes.className = "itemMeta";
    notes.style.marginTop = "8px";
    notes.textContent = `üóíÔ∏è ${m.notes.trim()}`;
    div.appendChild(notes);
  }

  div.addEventListener("click", () => editMatch(m.id));
  div.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") editMatch(m.id);
  });

  return div;
}

function renderMatches() {
  const list = $("matchesList");
  const empty = $("matchesEmpty");

  const q = $("searchInput").value.trim().toLowerCase();
  const v = $("filterVenue").value;
  const c = $("filterComp").value;
  const cr = $("filterCredit").value;

  const matches = getSeasonMatches(activeSeasonId())
    .filter(m => {
      if (v && m.venue !== v) return false;
      if (c && m.competition !== c) return false;
      if (cr && m.creditCounts !== cr) return false;
      if (q) {
        const hay = `${m.opponent} ${m.notes || ""}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    })
    .slice()
    .sort((a,b) => {
      const mode = ($("matchSort") ? $("matchSort").value : "matchDate");
      if (mode === "dateAdded") {
        return (Number(b.createdAt||0) - Number(a.createdAt||0));
      }
      return (b.matchDate || "").localeCompare(a.matchDate || "");
    });

  list.innerHTML = "";
  if (matches.length === 0) {
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");
  for (const m of matches) list.appendChild(matchCard(m));
}

function clearForm() {
  $("matchId").value = "";
  if ($("fixtureKey")) $("fixtureKey").value = "";
  $("opponent").value = "";
  $("matchDate").value = todayISODate();
  $("venue").value = "H";
  $("competition").value = "PL";
    $("ticketAction").value = "credit";
  setCreditChip("unsure");
  $("notes").value = "";
  $("amountPaid").value = "";
  $("btnDelete").hidden = true;
}

function setCreditChip(val) {
  const cc = $("creditCounts");
  if (cc) cc.value = val;
  document.querySelectorAll(".chip").forEach(ch => {
    ch.classList.toggle("active", ch.dataset.credit === val);
  });
}

function defaultCreditFromAction(action) {
  // Default credit behaviour from "Ticket" selection (user can override with chips)
  const map = {
    credit: "yes",
    season_return: "no",
    fwd_me_credit: "yes",
    fwd_me_nocredit: "no",
    hosp_credit: "yes",
    hosp_nocredit: "no",
    scan_nocredit: "no"
  };
  return map[action] || "unsure";
}

function upsertMatchFromForm() {
  const id = $("matchId").value || uid();
  const now = new Date().toISOString();

  const m = {
    id,
    accountId: activeAccountId(),
    seasonId: activeSeasonId(),
    opponent: $("opponent").value.trim(),
    venue: $("venue").value,
    competition: $("competition").value,
    matchDate: $("matchDate").value,
    appliedStatus: "na",
    ticketAction: $("ticketAction").value,
    creditCounts: $("creditCounts").value,
    notes: $("notes").value.trim(),
    fixtureKey: ($("fixtureKey") ? $("fixtureKey").value.trim() : ""),
    amountPaid: parseAmount($("amountPaid").value),
    createdAt: now,
    updatedAt: now
  };

  if (!m.opponent) {
    alert("Please enter an opponent.");
    return null;
  }

  // Prevent adding the same fixture twice (per account + season)
  const isNew = ($("matchId").value || "") === "";
  const fk = ($("fixtureKey") ? ($("fixtureKey").value || "").trim() : "");
  if (isNew) {
    const dup = state.data.matches.find(x =>
      x.accountId === m.accountId &&
      x.seasonId === m.seasonId &&
      (
        (fk && x.fixtureKey && x.fixtureKey === fk) ||
        (!fk && x.opponent === m.opponent && x.matchDate === m.matchDate && x.competition === m.competition && x.venue === m.venue)
      )
    );
    if (dup) {
      alert("That fixture is already in your tracked matches for this account/season.");
      return null;
    }
  }

  const existingIdx = state.data.matches.findIndex(x => x.id === id);
  if (existingIdx >= 0) {
    m.createdAt = state.data.matches[existingIdx].createdAt;
    state.data.matches[existingIdx] = m;
  } else {
    state.data.matches.push(m);
  }

  save();
  return m;
}

function editMatch(id) {
  const m = state.data.matches.find(x => x.id === id);
  if (!m) return;

  $("matchId").value = m.id;
  $("opponent").value = m.opponent || "";
  $("matchDate").value = m.matchDate || todayISODate();
  $("venue").value = m.venue || "H";
  $("competition").value = m.competition || "PL";
    $("ticketAction").value = m.ticketAction || "used";
  setCreditChip(m.creditCounts || "unsure");
  $("notes").value = m.notes || "";
  $("amountPaid").value = (m.amountPaid ?? "");

  $("btnDelete").hidden = false;
  setView("add");
}

function deleteCurrentMatch() {
  const id = $("matchId").value;
  if (!id) return;
  const ok = confirm("Delete this match entry?");
  if (!ok) return;

  state.data.matches = state.data.matches.filter(m => m.id !== id);
  save();
  clearForm();
  renderAll();
  setView("matches");
}

function downloadFile(filename, text, mime="application/octet-stream") {
  const blob = new Blob([text], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportJSON() {
  const payload = JSON.stringify(state.data, null, 2);
  downloadFile(`thlfc-credits-${activeSeasonId()}-${new Date().toISOString().slice(0,10)}.json`, payload, "application/json");
}

function escapeCSV(s) {
  const str = String(s ?? "");
  if (/[,\"\n]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
  return str;
}

function exportCSV() {
  const seasonId = activeSeasonId();
  const rows = getSeasonMatches(seasonId)
    .slice()
    .sort((a,b) => (a.matchDate || "").localeCompare(b.matchDate || ""));

  const header = [
    "season","opponent","venue","competition","matchDate",
    "appliedStatus","ticketAction","creditCounts","amountPaid","notes","createdAt","updatedAt"
  ];

  const lines = [header.join(",")];
  for (const m of rows) {
    lines.push([
      seasonLabel(m.seasonId),
      m.opponent,
      m.venue,
      m.competition,
      m.matchDate,
      m.appliedStatus,
      m.ticketAction,
      m.creditCounts,
      m.amountPaid,
      m.notes,
      m.createdAt,
      m.updatedAt
    ].map(escapeCSV).join(","));
  }

  downloadFile(`thlfc-credits-${seasonId}-${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"), "text/csv");
}

function importJSONFile(file) {
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const parsed = JSON.parse(String(reader.result));
      if (!parsed || !parsed.seasons || !parsed.matches) throw new Error("Bad format");
      state.data = parsed;
      save();
      renderAll();
      alert("Import complete ‚úÖ");
    } catch {
      alert("Import failed ‚ùå (Invalid JSON backup)");
    }
  };
  reader.readAsText(file);
}

function openSettings() {
  $("ruleForwardedNoCredit").checked = !!state.data.settings.ruleForwardedNoCredit;
  $("ruleReturnedNoCredit").checked = !!state.data.settings.ruleReturnedNoCredit;
  $("ruleHospitalityNoCredit").checked = !!state.data.settings.ruleHospitalityNoCredit;
  $("settingsModal").showModal();
}

function closeSettings() {
  $("settingsModal").close();
}

function bindSettings() {
  onEl("ruleForwardedNoCredit","change",(e) => {
    state.data.settings.ruleForwardedNoCredit = e.target.checked;
    save();
  });
  onEl("ruleReturnedNoCredit","change",(e) => {
    state.data.settings.ruleReturnedNoCredit = e.target.checked;
    save();
  });
  onEl("ruleHospitalityNoCredit","change",(e) => {
    state.data.settings.ruleHospitalityNoCredit = e.target.checked;
    save();
  });
}

function addSeason() {
  const label = prompt("Season label (e.g. 2026/27):");
  if (!label) return;
  const id = label.replace(/\s+/g, "-").replace(/\//g, "-").toLowerCase();
  if (state.data.seasons.some(s => s.id === id)) {
    alert("That season already exists.");
    return;
  }
  state.data.seasons.push({ id, label, createdAt: new Date().toISOString() });
  state.data.activeSeasonId = id;
  save();
  renderAll();
}

function renderAll() {
  renderSeasonSelect();
  renderAccountSelect();
  renderDashboard();
  renderMatches();
}

function setupPWA() {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    state.deferredPrompt = e;
    const btn = $("btnInstall");
    btn.hidden = false;
    btn.addEventListener("click", async () => {
      btn.hidden = true;
      state.deferredPrompt.prompt();
      await state.deferredPrompt.userChoice;
      state.deferredPrompt = null;
    }, { once: true });
  });
}

function onEl(id, evt, fn, opts) {
  const el = $(id);
  if (!el) return;
  el.addEventListener(evt, fn, opts);
}

function bindEvents() {
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      setView(tab.dataset.view);
      if (tab.dataset.view === "fixtures") {
        renderFixtures();
      }
    });
  });

  onEl("accountSelect","change",(e)=> setActiveAccount(e.target.value));
  onEl("seasonSelect","change",(e)=> setActiveSeason(e.target.value));
  onEl("btnAddAccount","click", openSetupForNewAccount);
  onEl("btnEditAccount","click", editActiveAccount);
  onEl("btnDeleteAccount","click", deleteActiveAccount);
  onEl("matchSort","change", renderMatches);

  
  $("btnClearForm").addEventListener("click", clearForm);

  document.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => setCreditChip(ch.dataset.credit));
  });

  $("ticketAction").addEventListener("change", (e) => {
    const cc = $("creditCounts");
    const current = cc ? cc.value : "unsure";
    if (current === "unsure") {
      setCreditChip(defaultCreditFromAction(e.target.value));
    }
  });

  onEl("btnReloadFixtures","click", ()=>{ fixturesCache=null; renderFixtures(); });
  onEl("fixtureShow","change", renderFixtures);
  onEl("fixtureComp","change", renderFixtures);

  // Credit chips
  document.querySelectorAll("[data-credit]").forEach(btn => {
    btn.addEventListener("click", () => {
      const val = btn.getAttribute("data-credit");
      setCreditChip(val);
    });
  });

  // Fixtures import
  const fxInput = document.getElementById("importFixturesFile");
  if (fxInput) {
    fxInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const parsed = parseICSFixtures(text);
      const existing = getImportedFixtures();
      const map = new Map();
      [...existing, ...parsed].forEach(f=>{ if(f && f.id) map.set(f.id, f); });
      setImportedFixtures(Array.from(map.values()));
      fixturesCache = null;
      try { showToast(`Imported ${parsed.length} fixtures`); } catch(e) { alert(`Imported ${parsed.length} fixtures`); }
const ce=document.getElementById("fixturesCount"); if(ce) ce.textContent = `Imported ${parsed.length} fixtures`;
      renderFixtures();
      fxInput.value = "";
    });
  }
  const clearBtn = document.getElementById("btnClearFixtures");
  if (clearBtn) {
    clearBtn.addEventListener("click", ()=>{
      setImportedFixtures([]);
      fixturesCache = null;
      alert("Imported fixtures cleared");
      renderFixtures();
    });
  }

  $("matchForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const m = upsertMatchFromForm();
    if (!m) return;
    clearForm();
    renderAll();
    setView("matches");
  });

  $("btnDelete").addEventListener("click", deleteCurrentMatch);

  ["searchInput","filterVenue","filterComp","filterCredit"].forEach(id => {
    $(id).addEventListener("input", renderMatches);
    $(id).addEventListener("change", renderMatches);
  });

  $("btnExportJSON").addEventListener("click", exportJSON);
  $("btnExportCSV").addEventListener("click", exportCSV);
  $("btnExportJSON2").addEventListener("click", exportJSON);
  $("btnExportCSV2").addEventListener("click", exportCSV);

  $("importFile").addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if (f) importJSONFile(f);
    e.target.value = "";
  });
  $("importFile2").addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if (f) importJSONFile(f);
    e.target.value = "";
  });

  onEl("btnSettings","click", openSettings);
  onEl("btnCloseSettings","click", closeSettings);
  bindSettings();

  // Setup screen
  onEl("setupCount","input", renderSetupNames);
  onEl("btnSetupCreate","click", () => { try { saveSetup(); } catch(e){ alert("Setup error: " + (e && e.message ? e.message : e)); console.error(e); } });

onEl("btnSupport","click", openSupport);
onEl("btnCloseSupport","click", closeSupport);
onEl("btnBmac","click", ()=> window.open(SUPPORT_BMAC_URL, "_blank", "noopener"));
onEl("btnSendFeedback","click", sendFeedback);
}

function init() {
  if (window.__THLFC_INITED) return;
  window.__THLFC_INITED = true;
  load();
  setupPWA();
  bindEvents();
  try { bindFixturesControls(); } catch(e) {}
  clearForm();
  renderAll();
  setView("dash");

  if (!state.data.accounts || state.data.accounts.length === 0) {
    setView("setup");
    renderSetupNames();
  
}
}

/* ---------- Accounts + Setup ---------- */


function renderSetupNames() {
  const wrap = $("setupNames");
  if (!wrap) return;

  const count = Math.max(1, Math.min(10, parseInt($("setupCount")?.value || "1", 10)));

    wrap.innerHTML = "";
  for (let i = 1; i <= count; i++) {
    const row = document.createElement("div");
    row.className = "item";

    row.innerHTML = `
      <div class="fieldLabel">Account ${i}</div>
      <input class="input" id="setupName_${i}" placeholder="${i === 1 ? "Me" : "Account " + i}" />

      <div class="fieldLabel" style="margin-top:10px;">AutoCup (Home) for this account</div>
      <div class="row wrap gap">
        <label class="toggle">
          <input type="checkbox" id="setupAccLC_${i}" />
          <span>League Cup</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="setupAccFAC_${i}" />
          <span>FA Cup</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="setupAccUCL_${i}" />
          <span>Champions League</span>
        </label>
      </div>

      <div class="hint" style="margin-top:8px;">AutoCup only affects <strong>HOME</strong> credits. Away credits still tracked.</div>
    `;

    wrap.appendChild(row);
  }
  try { populateAllSeasonSelects(); } catch(e) {}

}


function openSetupForNewAccount() {
  // Convenience: go to setup screen but keep existing accounts
  setView("setup");
  $("setupCount").value = "1";
  renderSetupNames();
}

function saveSetup() {
  const count = Math.max(1, Math.min(10, parseInt($("setupCount")?.value || "1", 10)));
  const season = $("setupSeason")?.value || activeSeasonId();
  setActiveSeason(season);

  const createdIds = [];

  // Create accounts from inputs (+ per-account AutoCup)
  for (let i = 1; i <= count; i++) {
    const val = ($("setupName_" + i)?.value || "").trim();
    const name = val || (i === 1 ? "Me" : `Account ${i}`);

    const autoCup = {
      LC: !!$("setupAccLC_" + i)?.checked,
      FAC: !!$("setupAccFAC_" + i)?.checked,
      UCL: !!$("setupAccUCL_" + i)?.checked
    };

    const acc = createAccount(name, autoCup);
    createdIds.push(acc.id);
  }

  // If adding a single new account, switch to it
  if (state.isAddingSingle && createdIds.length > 0) {
    setActiveAccount(createdIds[createdIds.length - 1]);
  } else if (!activeAccountId() && createdIds.length > 0) {
    setActiveAccount(createdIds[0]);
  }

  state.isAddingSingle = false;

  // Feedback
  try { showToast(`Saved ${createdIds.length} account(s)`); } catch(e) { if(createdIds.length===0) alert("No accounts were saved."); }

  renderAll();
  setView("dash");
}



function createAccount(name, autoCup={LC:false, FAC:false, UCL:false}) {
  const acc = {
    id: uid(),
    name: name.trim(),
    autoCup: {
      LC: !!autoCup.LC,
      FAC: !!autoCup.FAC,
      UCL: !!autoCup.UCL
    },
    createdAt: new Date().toISOString()
  };
  state.data.accounts.push(acc);
  if (!state.data.activeAccountId) state.data.activeAccountId = acc.id;
  save();
  return acc;
}



/* ---------- Fixtures ---------- */

var fixturesCache = null;




async function loadFixturesData() {
  if (fixturesCache) return fixturesCache;

  // Primary: embedded JSON in index.html (offline + SW-safe)
  try {
    const el = document.getElementById("fixturesData");
    if (el && el.textContent) {
      const arr = JSON.parse(el.textContent);
      fixturesCache = Array.isArray(arr) ? arr : [];
      return fixturesCache;
    }
  } catch(e) {}

  // Fallback: imported fixtures from localStorage
  try {
    const imported = getImportedFixtures();
    if (Array.isArray(imported) && imported.length) {
      fixturesCache = imported.slice();
      return fixturesCache;
    }
  } catch(e) {}

  fixturesCache = [];
  return fixturesCache;
}

function formatFixtureDate(f) {
  // Use date only (app stores matchDate only). Time may be 00:00 in feed.
  return f.date || (f.datetime_utc ? (f.datetime_utc.slice(0,10)) : "");
}

function fixtureRow(f) {
  const when = formatFixtureDate(f);
  const ha = (f.venue === "H") ? "H" : "A";
  const comp = f.competition || "OTHER";
  const opp = f.opponent || "‚Äî";
  const time = (f.time && f.time !== "00:00") ? ` ‚Ä¢ ${f.time}` : "";
  const el = document.createElement("div");
  el.className = "item clickable";
  el.innerHTML = `
    <div class="row space-between">
      <div>
        <div class="itemTitle">${opp}</div>
        <div class="hint">${when}${time} ‚Ä¢ ${comp} ‚Ä¢ ${ha}</div>
      </div>
      <div class="pill">${ha}</div>
    </div>
  `;
  el.addEventListener("click", () => prefillFromFixture(f));
  return el;
}

async function renderFixtures() {
  try {
    const listEl = document.getElementById("fixturesList");
    const emptyEl = document.getElementById("fixturesEmpty");
    const countEl = document.getElementById("fixturesCount");

    if (!listEl || !emptyEl) return;

    listEl.innerHTML = "";
    emptyEl.classList.add("hidden");
    if (countEl) countEl.textContent = "";

    const showSel = document.getElementById("fixtureShow");
    const compSel = document.getElementById("fixtureComp");
    const show = showSel ? showSel.value : "upcoming";
    const compFilter = compSel ? compSel.value : "";

    const data = (await loadFixturesData()).slice();
    if (countEl) countEl.textContent = `Loaded ${data.length} fixtures‚Ä¶`;

    const today = new Date();
    today.setUTCHours(0,0,0,0);

    let filtered = data.filter(f => {
      if (compFilter && f.competition !== compFilter) return false;
      const raw = (f.date || (f.datetime_utc||""));
      const d = parseYMD((raw || "").slice(0,10));
      if (!d) return false;
      if (show === "upcoming") return d >= today;
      if (show === "past") return d < today;
      return true;
    });

    filtered.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    if (show === "past") filtered.reverse();

    if (countEl) countEl.textContent = `Loaded ${data.length} fixtures ‚Ä¢ Showing ${filtered.length}`;

    if (filtered.length === 0) {
      emptyEl.classList.remove("hidden");
      emptyEl.textContent = (show === "past") ? "No past fixtures found." : "No fixtures match your filters.";
      return;
    }

    if (countEl) countEl.textContent = `Loaded ${data.length} fixtures ‚Ä¢ Showing ${filtered.length}`;

    listEl.innerHTML = filtered.map(f => {
      const when = (f.date || (f.datetime_utc||"").slice(0,10));
      const ha = (f.venue === "A") ? "A" : "H";
      const comp = f.competition || "OTHER";
      const opp = f.opponent || "‚Äî";
      const time = (f.time && f.time !== "00:00") ? ` ‚Ä¢ ${f.time}` : "";
      const fid = (f.id || "").replace(/"/g,'');
      return `
        <div class="item clickable" data-fixture-id="${fid}">
          <div class="row space-between">
            <div>
              <div class="itemTitle">${opp}</div>
              <div class="hint">${when}${time} ‚Ä¢ ${comp} ‚Ä¢ ${ha}</div>
            </div>
            <div class="pill">${ha}</div>
          </div>
        </div>
      `;
    }).join("");

    // Click delegation
    listEl.querySelectorAll("[data-fixture-id]").forEach(el => {
      el.addEventListener("click", () => {
        const id = el.getAttribute("data-fixture-id");
        const fx = filtered.find(x => x.id === id) || filtered[0];
        setView("add");
        setTimeout(() => { prefillFromFixture(fx); }, 0);
        try{ showToast('Fixture loaded ‚Äî complete ticket details then Save'); }catch(e){}
      });
    });

  } catch (e) {
    const emptyEl = document.getElementById("fixturesEmpty");
    if (emptyEl) {
      emptyEl.classList.remove("hidden");
      emptyEl.textContent = "Fixtures error: " + (e && e.message ? e.message : e);
    }
  }
}

function prefillFromFixture(f) {
  // Clear current form, then prefill and switch view
  clearForm();
  if ($("fixtureKey")) $("fixtureKey").value = (f.id || `${f.date||""}|${f.competition||""}|${f.venue||""}|${f.opponent||""}`);
  $("opponent").value = f.opponent || "";
  $("venue").value = (f.venue === "A") ? "A" : "H";
  // Map competitions to app options
  const comp = f.competition || "OTHER";
  if (["PL","UCL","FAC","LC","OTHER"].includes(comp)) {
    $("competition").value = comp;
  } else {
    $("competition").value = "OTHER";
  }
  $("matchDate").value = f.date || (f.datetime_utc ? f.datetime_utc.slice(0,10) : "");
  $("ticketAction").value = "credit";
  setCreditChip(defaultCreditFromAction("credit"));
  // Optional: store time in notes if provided
  if (f.time && f.time !== "00:00") {
    $("notes").value = `KO ${f.time} ‚Äî ${$("notes").value || ""}`.trim();
  }
  setView("add");
}


function parseYMD(ymd){
  // ymd: YYYY-MM-DD
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd||"");
  if(!m) return null;
  const y=+m[1], mo=+m[2]-1, d=+m[3];
  return new Date(Date.UTC(y,mo,d));
}

function showToast(msg){
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed";
  el.style.left="50%";
  el.style.bottom="24px";
  el.style.transform="translateX(-50%)";
  el.style.background="#111";
  el.style.color="#fff";
  el.style.padding="10px 14px";
  el.style.border="1px solid #333";
  el.style.borderRadius="999px";
  el.style.zIndex="9999";
  document.body.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transition="opacity .25s"; }, 1200);
  setTimeout(()=>{ el.remove(); }, 1600);
}

/* Fixtures: ensure controls always re-render */
(function(){
  const fs = document.getElementById("fixtureShow");
  const fc = document.getElementById("fixtureComp");
  const fr = document.getElementById("btnReloadFixtures");
  if (fs) fs.addEventListener("change", renderFixtures);
  if (fc) fc.addEventListener("change", renderFixtures);
  if (fr) fr.addEventListener("click", ()=>{ fixturesCache=null; renderFixtures(); });
  const clr = document.getElementById("btnClearFixtures");
  if (clr) clr.addEventListener("click", ()=>{ setImportedFixtures([]); fixturesCache=null; try{showToast("Cleared imported fixtures");}catch(e){} renderFixtures(); });
})();


/* ---------- Fixtures Import (ICS) ---------- */

function getImportedFixtures(){
  try {
    const raw = localStorage.getItem("thlfc_importedFixtures");
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch(e){ return []; }
}

function setImportedFixtures(arr){
  try { localStorage.setItem("thlfc_importedFixtures", JSON.stringify(arr || [])); } catch(e){}
}

function parseICSDate(line){
  // Supports: DTSTART:20260131T200000Z  or DTSTART:20260131
  const m = line.match(/DTSTART[^:]*:(\d{8})(T(\d{6})Z?)?/);
  if(!m) return null;
  const y=m[1].slice(0,4), mo=m[1].slice(4,6), d=m[1].slice(6,8);
  const dateStr = `${y}-${mo}-${d}`;
  let time="00:00";
  if(m[3]){
    time = `${m[3].slice(0,2)}:${m[3].slice(2,4)}`;
  }
  return { date: dateStr, time };
}

function cleanSummaryForTeams(s){
  return (s||"").replace(/[^\w\s\/\-\.\&]/g,"").trim();
}

function opponentVenueFromSummary(summary){
  const s = cleanSummaryForTeams(summary);
  const parts = s.split(/\s+vs\s+/i);
  if(parts.length!==2) return { opponent:s, venue:"H" };
  const left=parts[0].trim(), right=parts[1].trim();
  if(left.toLowerCase().startsWith("liverpool")) return { opponent:right, venue:"H" };
  return { opponent:left, venue:"A" };
}

function compFromDesc(desc){
  const d=(desc||"").toLowerCase();
  if(d.includes("premier league")) return "PL";
  if(d.includes("champions league")) return "UCL";
  if(d.includes("fa cup")) return "FAC";
  if(d.includes("carabao") || d.includes("league cup")) return "LC";
  return "OTHER";
}

function parseICSFixtures(text){
  const out=[];
  const blocks = text.split("BEGIN:VEVENT").slice(1);
  for(const b of blocks){
    const dtLine = (b.match(/DTSTART[^\r\n]*/)||[])[0];
    if(!dtLine) continue;
    const dt=parseICSDate(dtLine);
    if(!dt) continue;
    const summary = (b.match(/SUMMARY:(.+)\r?\n/)||[])[1] || "";
    const desc = (b.match(/DESCRIPTION:(.+)\r?\n/)||[])[1] || "";
    const loc = (b.match(/LOCATION:(.+)\r?\n/)||[])[1] || "";
    const {opponent, venue} = opponentVenueFromSummary(summary);
    const competition = compFromDesc(desc);
    const id = `${dt.date}-${competition.toLowerCase()}-${opponent.replace(/\s+/g,"").toLowerCase()}-${venue.toLowerCase()}-${dt.time.replace(":","")}`;
    out.push({
      id,
      date: dt.date,
      time: dt.time,
      datetime_utc: `${dt.date}T${dt.time}:00Z`,
      competition,
      opponent,
      venue,
      location: loc
    });
  }
  // de-dup
  const seen=new Set();
  return out.filter(f=>{ if(seen.has(f.id)) return false; seen.add(f.id); return true; });
}

// Force SW to check for updates (helps Netlify deploys)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistration().then(reg => { if (reg) reg.update(); });
}

function bindFixturesControls(){
  const fs = document.getElementById("fixtureShow");
  const fc = document.getElementById("fixtureComp");
  const fr = document.getElementById("btnReloadFixtures");
  if (fs) fs.onchange = () => renderFixtures();
  if (fc) fc.onchange = () => renderFixtures();
  if (fr) fr.onclick = () => { fixturesCache = null; renderFixtures(); };
}

function seasonLabel(startYY){
  const a = String(startYY).padStart(2,'0');
  const b = String((startYY+1)%100).padStart(2,'0');
  return `${a}/${b}`;
}
function populateSeasonSelect(sel){
  if(!sel) return;
  // Always rebuild options (some templates insert a placeholder option)
  const current = sel.value || "";
  sel.innerHTML = "";
  const now = new Date();
  const yy = now.getFullYear() % 100;
  const seasonStart = (now.getMonth() >= 6) ? yy : ((yy + 99) % 100); // July+ => YY/YY+1 else (YY-1)/YY
  for(let i=0;i<8;i++){
    const label = seasonLabel((seasonStart+i)%100);
    const opt = document.createElement("option");
    opt.value = label;
    opt.textContent = label;
    sel.appendChild(opt);
  }
  // Restore previous selection if possible
  if (current) sel.value = current;
}
function populateAllSeasonSelects(){
  document.querySelectorAll('select.seasonSelect, select[data-role="season"]').forEach(populateSeasonSelect);
}


// Ensure init runs after DOM
if (typeof init === "function") {
  document.addEventListener("DOMContentLoaded", () => {
    try { init(); } catch(e) { console.error("Init error", e); alert("App error: " + ((e && e.message) ? e.message : e)); }
  });
}


function editActiveAccount(){
  const accId = activeAccountId();
  const acc = state.data.accounts.find(a=>a.id===accId);
  if(!acc){ alert("No account selected"); return; }
  const newName = prompt("Account name:", acc.name || "");
  if(newName === null) return;
  acc.name = (newName || "").trim() || acc.name;

  // Autocup toggles (per account)
  const ac = acc.autoCup || {LC:false,FAC:false,UCL:false};
  const lc = confirm("AutoCup (HOME) ‚Äî League Cup?\nOK = Yes, Cancel = No");
  const fac = confirm("AutoCup (HOME) ‚Äî FA Cup?\nOK = Yes, Cancel = No");
  const ucl = confirm("AutoCup (HOME) ‚Äî Champions League?\nOK = Yes, Cancel = No");
  acc.autoCup = {LC:lc, FAC:fac, UCL:ucl};

  save();
  renderAccountSelect();
  renderAll();
  showToast("Account updated");
}

function deleteActiveAccount(){
  const accId = activeAccountId();
  const acc = state.data.accounts.find(a=>a.id===accId);
  if(!acc){ alert("No account selected"); return; }
  if(state.data.accounts.length <= 1){
    alert("You must have at least 1 account.");
    return;
  }
  const ok = confirm(`Delete account "${acc.name}"?\nThis will also delete all tracked matches for this account.`);
  if(!ok) return;

  state.data.accounts = state.data.accounts.filter(a=>a.id!==accId);
  state.data.matches = state.data.matches.filter(m=>m.accountId!==accId);

  // Set new active account
  state.data.activeAccountId = state.data.accounts[0]?.id || null;
  save();
  renderAccountSelect();
  renderAll();
  showToast("Account deleted");
}


function openSupport(){
  const dlg = $("supportModal");
  if (!dlg) return;
  dlg.classList.remove("hidden");
  if (dlg.showModal) dlg.showModal();
  else dlg.setAttribute("open","");
  // clear status
  const st = $("feedbackStatus");
  if (st) st.textContent = "";
}

function closeSupport(){
  const dlg = $("supportModal");
  if (!dlg) return;
  try { dlg.close(); } catch(e) {}
  dlg.classList.add("hidden");
}

function sendFeedback(){
  const msg = ($("feedbackMsg")?.value || "").trim();
  const email = ($("feedbackEmail")?.value || "").trim();
  const status = $("feedbackStatus");

  if (!msg){
    if (status) status.textContent = "Please enter a message first.";
    return;
  }

  // Default: open device email app (works without any backend)
  const subject = encodeURIComponent("TicketHelpLFC Credit Tracker Feedback");
  const body = encodeURIComponent(
    (email ? ("From: " + email + "\n\n") : "") +
    msg +
    "\n\n---\nSent from the Credit Tracker app"
  );

  // If you later want silent sending, we can swap this for a Formspree/Netlify endpoint.
  window.location.href = `mailto:${FEEDBACK_TO_EMAIL}?subject=${subject}&body=${body}`;

  if (status) status.textContent = "Opening your email app‚Ä¶";
}
</script>script>

</body>
</html>
    <!-- Fixtures -->
    <section id="viewFixtures" class="view hidden">
      <section class="card">
        <div class="row space-between">
          <div>
            <div class="label">üìÖ Fixtures</div>
            <div class="hint">Tap a fixture to pre-fill the Add screen.</div>
          </div>
          <button id="btnReloadFixtures" class="btn ghost">üîÑ Refresh</button>
          <label class="btn ghost fileBtn">üì• Import fixtures (ICS)
            <input id="importFixturesFile" type="file" accept=".ics,text/calendar" hidden />
          </label>
          <button id="btnClearFixtures" class="btn ghost">üßπ Clear imported</button>
        </div>

        <div class="grid2">
          <div>
            <div class="fieldLabel">Show</div>
            <select id="fixtureShow" class="select">
              <option value="upcoming" selected>Upcoming</option>
              <option value="past">Past</option>
              <option value="all">All</option>
            </select>
          </div>
          <div>
            <div class="fieldLabel">Filter</div>
            <select id="fixtureComp" class="select">
              <option value="" selected>All competitions</option>
              <option value="PL">PL</option>
              <option value="UCL">UCL</option>
              <option value="FAC">FA Cup</option>
              <option value="LC">League Cup</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
        </div>

        <div class="hint" id="fixturesCount" style="margin-top:10px;"></div>
        <div id="fixturesList" class="list" style="margin-top:12px;"></div>
        <div id="fixturesEmpty" class="hint hidden" style="margin-top:12px;">No fixtures found.</div>
      </section>
    </section>


